
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 視覺風格分析器 (Gemini Powered)</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }
        .main-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background-color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: #0d6efd;
            background-color: #f1f7ff;
        }
        .upload-icon {
            font-size: 48px;
            color: #6c757d;
            margin-bottom: 15px;
        }
        .preview-container {
            margin-top: 20px;
            text-align: center;
            display: none;
        }
        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .preview-file-icon {
            font-size: 64px;
            color: #dc3545;
        }
        .result-area {
            background-color: #212529;
            color: #00ff9d; /* Matrix-like green for code */
            font-family: 'Consolas', 'Monaco', monospace;
            border-radius: 5px;
            padding: 15px;
            width: 100%;
            min-height: 250px;
            margin-top: 20px;
            resize: vertical;
            border: 1px solid #343a40;
        }
        /* Style for the PDF render target to ensure it looks good */
        #pdf-render-source {
            background-color: white;
            padding: 20px;
            border: 1px solid #ddd;
            color: #000;
            font-family: 'Microsoft JhengHei', sans-serif;
            display: none; /* Hidden by default, used for PDF generation */
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .config-section {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <div class="main-container">
        
        <!-- Header -->
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-magic me-2"></i>AI 視覺風格分析器</h4>
            </div>
        </div>

        <!-- Configuration Section -->
        <div class="config-section">
            <h5 class="mb-3 text-secondary"><i class="fas fa-cogs me-2"></i>設定</h5>
            
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="apiKey" class="form-label fw-bold small">Google AI Studio API Key</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text"><i class="fas fa-key"></i></span>
                        <input type="password" class="form-control" id="apiKey" placeholder="貼上 API Key" autocomplete="off">
                    </div>
                </div>
                <div class="col-md-6">
                    <label for="sheetUrl" class="form-label fw-bold small">Google Apps Script URL (選填)</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text"><i class="fas fa-table"></i></span>
                        <input type="text" class="form-control" id="sheetUrl" placeholder="貼上 Web App URL 以啟用自動匯入" autocomplete="off">
                    </div>
                </div>
            </div>
            <div class="form-text mt-2">您的金鑰與網址僅儲存於本地瀏覽器，不會傳送至我們的伺服器。</div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                
                <!-- Upload Section -->
                <div class="upload-area" id="dropZone">
                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    <h5>拖曳檔案至此 或 點擊上傳</h5>
                    <p class="text-muted mb-0">支援格式：JPG, PNG, WEBP, PDF</p>
                    <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,.webp,.pdf" style="display: none;">
                </div>

                <!-- File Preview -->
                <div class="preview-container" id="previewContainer">
                    <div id="imagePreviewBox" style="display: none;">
                        <img src="" alt="Preview" class="preview-image" id="imgPreview">
                    </div>
                    <div id="filePreviewBox" style="display: none;">
                        <i class="fas fa-file-pdf preview-file-icon"></i>
                        <p class="mt-2 fw-bold" id="fileName">filename.pdf</p>
                    </div>
                    <button class="btn btn-outline-danger btn-sm mt-2" id="removeFileBtn">移除檔案</button>
                </div>

                <!-- Action Button -->
                <div class="d-grid gap-2 mt-4">
                    <button class="btn btn-primary btn-lg" id="analyzeBtn" disabled>
                        <i class="fas fa-search me-2"></i>開始 AI 風格分析
                    </button>
                </div>

                <!-- Result Section -->
                <div class="mt-4">
                    <label for="resultOutput" class="form-label fw-bold">分析結果 (YAML)</label>
                    <textarea class="form-control result-area" id="resultOutput" readonly placeholder="等待分析結果..."></textarea>
                    
                    <!-- Export Buttons -->
                    <div class="mt-3 d-flex flex-wrap gap-2 justify-content-end">
                        <button class="btn btn-outline-primary" id="copyBtn" disabled>
                            <i class="fas fa-copy me-1"></i> 複製
                        </button>
                        <button class="btn btn-success" id="sendSheetBtn" disabled style="display: none;">
                            <i class="fas fa-paper-plane me-1"></i> 傳送至 Google Sheet
                        </button>
                        <button class="btn btn-outline-success" id="downloadCsvBtn" disabled>
                            <i class="fas fa-file-csv me-1"></i> 下載 .csv
                        </button>
                        <button class="btn btn-outline-secondary" id="downloadTxtBtn" disabled>
                            <i class="fas fa-file-alt me-1"></i> 下載 .txt
                        </button>
                        <button class="btn btn-outline-danger" id="downloadPdfBtn" disabled>
                            <i class="fas fa-file-pdf me-1"></i> 下載 .pdf
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden element for PDF generation (ensures clean styling for the PDF) -->
    <div id="pdf-render-source">
        <h2 style="border-bottom: 2px solid #333; padding-bottom: 10px;">視覺風格分析報告</h2>
        <p><strong>產出時間：</strong> <span id="pdfDate"></span></p>
        <hr>
        <pre id="pdfContent" style="white-space: pre-wrap; font-family: 'Courier New', Courier, monospace; background: #f4f4f4; padding: 15px; border-radius: 5px;"></pre>
        <p style="margin-top: 20px; font-size: 12px; color: #666;">Generated by Gemini AI Style Analyzer</p>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h5 class="mt-3 text-secondary">正在分析檔案風格中...</h5>
        <p class="text-muted small">這可能需要幾秒鐘 (PDF 可能較久)</p>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const imgPreview = document.getElementById('imgPreview');
        const imagePreviewBox = document.getElementById('imagePreviewBox');
        const filePreviewBox = document.getElementById('filePreviewBox');
        const fileNameDisplay = document.getElementById('fileName');
        const removeFileBtn = document.getElementById('removeFileBtn');
        const apiKeyInput = document.getElementById('apiKey');
        const sheetUrlInput = document.getElementById('sheetUrl');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const resultOutput = document.getElementById('resultOutput');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const downloadTxtBtn = document.getElementById('downloadTxtBtn');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const downloadCsvBtn = document.getElementById('downloadCsvBtn');
        const copyBtn = document.getElementById('copyBtn');
        const sendSheetBtn = document.getElementById('sendSheetBtn');

        // State
        let currentFile = null;
        let currentBase64 = null;

        // --- Event Listeners ---

        // Drag & Drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
        });

        dropZone.addEventListener('drop', handleDrop, false);
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFiles);
        removeFileBtn.addEventListener('click', resetFile);

        // Analysis
        analyzeBtn.addEventListener('click', startAnalysis);

        // Exports
        downloadTxtBtn.addEventListener('click', exportToTxt);
        downloadPdfBtn.addEventListener('click', exportToPdf);
        downloadCsvBtn.addEventListener('click', exportToCsv);
        copyBtn.addEventListener('click', copyToClipboard);
        
        // Sheet Integration
        sheetUrlInput.addEventListener('input', toggleSheetButton);
        sendSheetBtn.addEventListener('click', sendToSheet);

        // --- Functions ---

        function toggleSheetButton() {
            if (sheetUrlInput.value.trim().length > 0 && !sendSheetBtn.disabled && resultOutput.value.length > 0) {
                sendSheetBtn.style.display = 'inline-block';
            } else if (resultOutput.value.length === 0) {
                sendSheetBtn.style.display = 'none';
            } else if (sheetUrlInput.value.trim().length === 0) {
                sendSheetBtn.style.display = 'none';
            } else {
                sendSheetBtn.style.display = 'inline-block';
            }
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles({ target: { files: files } });
        }

        function handleFiles(e) {
            const file = e.target.files[0];
            if (!file) return;

            const validTypes = ['image/jpeg', 'image/png', 'image/webp', 'application/pdf'];
            if (!validTypes.includes(file.type)) {
                alert('不支援的檔案格式。請上傳 JPG, PNG, WEBP 或 PDF。');
                return;
            }

            currentFile = file;
            
            const reader = new FileReader();
            reader.onloadend = function() {
                currentBase64 = reader.result.split(',')[1];
            }
            reader.readAsDataURL(file);

            previewContainer.style.display = 'block';
            dropZone.style.display = 'none';
            analyzeBtn.disabled = false;

            if (file.type.startsWith('image/')) {
                imagePreviewBox.style.display = 'block';
                filePreviewBox.style.display = 'none';
                imgPreview.src = URL.createObjectURL(file);
            } else {
                imagePreviewBox.style.display = 'none';
                filePreviewBox.style.display = 'block';
                fileNameDisplay.textContent = file.name;
            }
        }

        function resetFile() {
            currentFile = null;
            currentBase64 = null;
            fileInput.value = '';
            previewContainer.style.display = 'none';
            dropZone.style.display = 'block';
            analyzeBtn.disabled = true;
            resultOutput.value = '';
            disableExportButtons();
        }

        function disableExportButtons() {
            downloadTxtBtn.disabled = true;
            downloadPdfBtn.disabled = true;
            downloadCsvBtn.disabled = true;
            copyBtn.disabled = true;
            sendSheetBtn.disabled = true;
        }

        function enableExportButtons() {
            downloadTxtBtn.disabled = false;
            downloadPdfBtn.disabled = false;
            downloadCsvBtn.disabled = false;
            copyBtn.disabled = false;
            sendSheetBtn.disabled = false;
            toggleSheetButton();
        }

        async function startAnalysis() {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                alert('請輸入 Google AI Studio API Key');
                return;
            }
            if (!currentBase64) {
                alert('請先上傳檔案');
                return;
            }

            loadingOverlay.style.display = 'flex';
            analyzeBtn.disabled = true;
            resultOutput.value = '正在聯繫 Gemini 進行分析...';

            try {
                const promptText = `
                    You are a professional visual design expert. 
                    Analyze the uploaded file (image or PDF document).
                    Identify the visual style, name it, describe it, and extract the color palette.
                    
                    Return the result STRICTLY in YAML format.
                    DO NOT include markdown code blocks (like \`\`\`yaml).
                    
                    The output must follow this structure:
                    style_name: "Name of the style (in Traditional Chinese)"
                    style_description: "A detailed description of the style (in Traditional Chinese)"
                    primary_colors: 
                      - "#HexCode"
                      - "#HexCode"
                    secondary_colors:
                      - "#HexCode"
                      - "#HexCode"
                    
                    Ensure the color codes are valid HEX codes.
                `;

                // Using gemini-2.5-flash-preview-09-2025
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: promptText },
                                { inlineData: { mimeType: currentFile.type, data: currentBase64 } }
                            ]
                        }]
                    })
                });

                const data = await response.json();

                if (data.error) throw new Error(data.error.message);

                let text = data.candidates[0].content.parts[0].text;
                text = text.replace(/```yaml/g, '').replace(/```/g, '').trim();

                resultOutput.value = text;
                enableExportButtons();

            } catch (error) {
                console.error(error);
                resultOutput.value = `發生錯誤: ${error.message}`;
                alert(`分析失敗: ${error.message}`);
            } finally {
                loadingOverlay.style.display = 'none';
                analyzeBtn.disabled = false;
            }
        }

        // --- Helper: Parse Data (IMPROVED) ---
        function getParsedData() {
            const content = resultOutput.value;
            if (!content) return null;

            const getVal = (key) => {
                const regex = new RegExp(`${key}:\\s*"?(.*?)"?$`, "m");
                const match = content.match(regex);
                return match ? match[1].replace(/"/g, '') : "";
            };

            // Improved List Parsing:
            // 1. Matches key followed by colon
            // 2. Captures content until next root-level key (start of line) or end of file
            // 3. Extracts both 3-digit (#fff) and 6-digit (#ffffff) hex codes
            const getList = (key) => {
                // Use a safer regex that looks for the key, then grabs everything until the next newline that looks like a key
                // Or simply grab the next few lines
                const regex = new RegExp(`${key}:([\\s\\S]*?)(?=\\n[\\w]+:|$)`, "i");
                const match = content.match(regex);
                
                if (!match || !match[1]) return "";
                
                // Match hex codes (3 or 6 chars)
                const hexes = match[1].match(/#[A-Fa-f0-9]{3,6}\b/g);
                return hexes ? hexes.join("; ") : "未偵測到色票";
            };

            return {
                filename: currentFile ? currentFile.name : "unknown_file",
                style_name: getVal("style_name"),
                description: getVal("style_description"),
                primary: getList("primary_colors"),
                secondary: getList("secondary_colors")
            };
        }

        // --- Sheet Integration ---
        async function sendToSheet() {
            const url = sheetUrlInput.value.trim();
            if (!url) {
                alert("請先在設定區輸入 Google Apps Script URL");
                return;
            }

            const data = getParsedData();
            if (!data) return;

            const originalBtnText = sendSheetBtn.innerHTML;
            sendSheetBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 傳送中...';
            sendSheetBtn.disabled = true;

            try {
                // Fetch with mode 'no-cors' is required for simple client-side calls to GAS Web Apps
                await fetch(url, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify(data)
                });

                alert("請求已發送！\n資料應已寫入您的 Google Sheet。\n\n(若 Sheet 中仍無顏色，請檢查 Apps Script 是否正確接收 data.primary 和 data.secondary)");
                
            } catch (error) {
                console.error(error);
                alert("傳送失敗，請檢查 URL 是否正確，或 Apps Script 是否已部署為「任何人」可存取。");
            } finally {
                sendSheetBtn.innerHTML = originalBtnText;
                sendSheetBtn.disabled = false;
            }
        }

        // --- Existing Export Functions ---
        function copyToClipboard() {
            const content = resultOutput.value;
            if (!content) return;
            resultOutput.select();
            resultOutput.setSelectionRange(0, 99999);
            try {
                const successful = document.execCommand('copy');
                if(successful) {
                    const originalHtml = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<i class="fas fa-check me-1"></i> 已複製';
                    copyBtn.classList.replace('btn-outline-primary', 'btn-success');
                    setTimeout(() => {
                        copyBtn.innerHTML = originalHtml;
                        copyBtn.classList.replace('btn-success', 'btn-outline-primary');
                    }, 2000);
                } else alert('複製失敗');
            } catch (err) { alert('不支援自動複製'); }
            window.getSelection().removeAllRanges();
        }

        function exportToTxt() {
            const content = resultOutput.value;
            if (!content) return;
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `style_analysis_${new Date().getTime()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportToCsv() {
            const data = getParsedData();
            if (!data) return;

            const date = new Date().toLocaleString('zh-TW');
            const csvContent = "\uFEFF" + 
                "檔案名稱,分析日期,風格名稱,風格描述,主色系,輔助色系\n" +
                `"${data.filename}","${date}","${data.style_name}","${data.description}","${data.primary}","${data.secondary}"`;

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `style_analysis_${new Date().getTime()}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function exportToPdf() {
            const content = resultOutput.value;
            if (!content) return;
            const renderTarget = document.getElementById('pdf-render-source');
            document.getElementById('pdfContent').textContent = content;
            document.getElementById('pdfDate').textContent = new Date().toLocaleString('zh-TW');
            renderTarget.style.display = 'block';

            try {
                const originalText = downloadPdfBtn.innerHTML;
                downloadPdfBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 處理中...';
                downloadPdfBtn.disabled = true;

                const canvas = await html2canvas(renderTarget, { scale: 2, useCORS: true });
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                pdf.save(`style_analysis_${new Date().getTime()}.pdf`);
            } catch (error) {
                console.error(error);
                alert('PDF 產生失敗');
            } finally {
                renderTarget.style.display = 'none';
                downloadPdfBtn.innerHTML = '<i class="fas fa-file-pdf me-1"></i> 下載 .pdf';
                downloadPdfBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
