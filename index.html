<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 視覺風格分析器 (Gemini Powered)</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }
        .main-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background-color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: #0d6efd;
            background-color: #f1f7ff;
        }
        .upload-icon {
            font-size: 48px;
            color: #6c757d;
            margin-bottom: 15px;
        }
        .preview-container {
            margin-top: 20px;
            text-align: center;
            display: none;
        }
        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .preview-file-icon {
            font-size: 64px;
            color: #dc3545;
        }
        .result-area {
            background-color: #212529;
            color: #00ff9d; /* Matrix-like green for code */
            font-family: 'Consolas', 'Monaco', monospace;
            border-radius: 5px;
            padding: 15px;
            width: 100%;
            min-height: 250px;
            margin-top: 20px;
            resize: vertical;
            border: 1px solid #343a40;
        }
        /* Style for the PDF render target to ensure it looks good */
        #pdf-render-source {
            background-color: white;
            padding: 20px;
            border: 1px solid #ddd;
            color: #000;
            font-family: 'Microsoft JhengHei', sans-serif;
            display: none; /* Hidden by default, used for PDF generation */
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .config-section {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .control-panel {
            background-color: #fcfcfc;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <div class="main-container">
        
        <!-- Header -->
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-magic me-2"></i>AI 視覺風格分析器</h4>
            </div>
        </div>

        <!-- Configuration Section -->
        <div class="config-section">
            <h5 class="mb-3 text-secondary"><i class="fas fa-cogs me-2"></i>設定</h5>
            
            <div class="row g-3">
                <div class="col-md-6">
                    <!-- API Key (Highlighted in Red) -->
                    <label for="apiKey" class="form-label fw-bold small text-danger">Google AI Studio API Key</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text"><i class="fas fa-key"></i></span>
                        <input type="password" class="form-control" id="apiKey" placeholder="貼上 API Key" autocomplete="off">
                    </div>
                </div>
                <div class="col-md-6">
                    <label for="sheetUrl" class="form-label fw-bold small">Google Apps Script URL (選填)</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text"><i class="fas fa-table"></i></span>
                        <input type="text" class="form-control" id="sheetUrl" placeholder="貼上 Web App URL 以啟用自動匯入" autocomplete="off">
                    </div>
                </div>
            </div>
            <div class="form-text mt-2">您的金鑰與網址僅儲存於本地瀏覽器，不會傳送至我們的伺服器。</div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                
                <!-- Upload Section -->
                <div class="upload-area" id="dropZone">
                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    <h5>拖曳檔案至此 或 點擊上傳</h5>
                    <p class="text-muted mb-0">支援格式：JPG, PNG, WEBP, PDF</p>
                    <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,.webp,.pdf" style="display: none;">
                </div>

                <!-- File Preview -->
                <div class="preview-container" id="previewContainer">
                    <div id="imagePreviewBox" style="display: none;">
                        <img src="" alt="Preview" class="preview-image" id="imgPreview">
                    </div>
                    <div id="filePreviewBox" style="display: none;">
                        <i class="fas fa-file-pdf preview-file-icon"></i>
                        <p class="mt-2 fw-bold" id="fileName">filename.pdf</p>
                    </div>
                    <button class="btn btn-outline-danger btn-sm mt-2" id="removeFileBtn">移除檔案</button>
                </div>

                <!-- Control Panel (Highlighted Menu in Green) -->
                <div class="control-panel">
                    <label class="form-label fw-bold text-success"><i class="fas fa-sliders-h me-1"></i> 風格分析選單</label>
                    
                    <!-- Selection Menu -->
                    <select class="form-select mb-3" id="analysisType">
                        <option value="reverse_prompt" selected>1. 深度分析並產生高品質 AI 繪圖提示詞 (純文字)</option>
                        <option value="analyze_image" class="text-primary fw-bold">2. 依據圖片分析七大區塊資料 (可傳送至 Sheet)</option>
                        <option value="analyze_slide" class="text-primary fw-bold">3. 依據簡報分析七大區塊資料 (可傳送至 Sheet)</option>
                        <option value="custom">4. 使用者自行輸入分析資料要求 (純文字)</option>
                    </select>

                    <!-- Dynamic Input: Custom Prompt (Visible for Option 4) -->
                    <div id="customPromptGroup" class="mb-3" style="display: none;">
                        <label for="customPromptInput" class="form-label text-primary fw-bold">自定義提示詞內容</label>
                        <textarea class="form-control" id="customPromptInput" rows="3" placeholder="請輸入您想詢問 AI 的具體指令..."></textarea>
                    </div>
                    
                    <!-- Hint -->
                    <div id="sheetHint" class="alert alert-info py-2 small" style="display: none;">
                        <i class="fas fa-info-circle me-1"></i> 此模式將分析上傳檔案並產生結構化資料，支援直接傳送至 Google Sheet。<br>
                        <strong>Prompt 升級：</strong> 強制要求完整中文翻譯，確保每個細節都有中英對照。
                    </div>

                    <!-- Action Button -->
                    <div class="d-grid gap-2 mt-3">
                        <button class="btn btn-primary btn-lg" id="analyzeBtn" disabled>
                            <i class="fas fa-search me-2"></i>開始 AI 風格分析
                        </button>
                    </div>
                </div>

                <!-- Result Section (Highlighted in Blue) -->
                <div class="mt-4">
                    <label for="resultOutput" class="form-label fw-bold text-primary">分析結果</label>
                    <textarea class="form-control result-area" id="resultOutput" readonly placeholder="等待分析結果..."></textarea>
                    
                    <!-- Export Buttons -->
                    <div class="mt-3 d-flex flex-wrap gap-2 justify-content-end">
                        <button class="btn btn-outline-primary" id="copyBtn" disabled>
                            <i class="fas fa-copy me-1"></i> 複製
                        </button>
                        <button class="btn btn-success" id="sendSheetBtn" disabled style="display: none;">
                            <i class="fas fa-paper-plane me-1"></i> 傳送至 Google Sheet
                        </button>
                        <button class="btn btn-outline-success" id="downloadCsvBtn" disabled>
                            <i class="fas fa-file-csv me-1"></i> 下載 .csv
                        </button>
                        <button class="btn btn-outline-secondary" id="downloadTxtBtn" disabled>
                            <i class="fas fa-file-alt me-1"></i> 下載 .txt
                        </button>
                        <button class="btn btn-outline-danger" id="downloadPdfBtn" disabled>
                            <i class="fas fa-file-pdf me-1"></i> 下載 .pdf
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden element for PDF generation -->
    <div id="pdf-render-source">
        <h2 style="border-bottom: 2px solid #333; padding-bottom: 10px;">視覺風格分析報告</h2>
        <p><strong>產出時間：</strong> <span id="pdfDate"></span></p>
        <hr>
        <pre id="pdfContent" style="white-space: pre-wrap; font-family: 'Courier New', Courier, monospace; background: #f4f4f4; padding: 15px; border-radius: 5px;"></pre>
        <p style="margin-top: 20px; font-size: 12px; color: #666;">Generated by Gemini AI Style Analyzer</p>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h5 class="mt-3 text-secondary">正在分析檔案風格中...</h5>
        <p class="text-muted small">這可能需要幾秒鐘 (PDF 可能較久)</p>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const imgPreview = document.getElementById('imgPreview');
        const imagePreviewBox = document.getElementById('imagePreviewBox');
        const filePreviewBox = document.getElementById('filePreviewBox');
        const fileNameDisplay = document.getElementById('fileName');
        const removeFileBtn = document.getElementById('removeFileBtn');
        const apiKeyInput = document.getElementById('apiKey');
        const sheetUrlInput = document.getElementById('sheetUrl');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const resultOutput = document.getElementById('resultOutput');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const downloadTxtBtn = document.getElementById('downloadTxtBtn');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const downloadCsvBtn = document.getElementById('downloadCsvBtn');
        const copyBtn = document.getElementById('copyBtn');
        const sendSheetBtn = document.getElementById('sendSheetBtn');

        // Control Elements
        const analysisTypeSelect = document.getElementById('analysisType');
        const customPromptGroup = document.getElementById('customPromptGroup');
        const customPromptInput = document.getElementById('customPromptInput');
        const sheetHint = document.getElementById('sheetHint');

        // State
        let currentFile = null;
        let currentBase64 = null;

        // --- Event Listeners ---

        // Drag & Drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
        });

        dropZone.addEventListener('drop', handleDrop, false);
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFiles);
        removeFileBtn.addEventListener('click', resetFile);

        // Analysis Type Change
        analysisTypeSelect.addEventListener('change', handleAnalysisTypeChange);

        // Analysis
        analyzeBtn.addEventListener('click', startAnalysis);

        // Exports
        downloadTxtBtn.addEventListener('click', exportToTxt);
        downloadPdfBtn.addEventListener('click', exportToPdf);
        downloadCsvBtn.addEventListener('click', exportToCsv);
        copyBtn.addEventListener('click', copyToClipboard);
        
        // Sheet Integration
        sheetUrlInput.addEventListener('input', toggleSheetButton);
        sendSheetBtn.addEventListener('click', sendToSheet);

        // --- Functions ---

        function handleAnalysisTypeChange() {
            const type = analysisTypeSelect.value;
            
            // Hide all dynamic inputs first
            customPromptGroup.style.display = 'none';
            sheetHint.style.display = 'none';

            // Show relevant input
            if (type === 'custom') {
                customPromptGroup.style.display = 'block';
                customPromptInput.focus();
            } else if (type === 'analyze_image' || type === 'analyze_slide') {
                sheetHint.style.display = 'block';
            }
        }

        function toggleSheetButton() {
            // Only show sheet button if URL is present and analysis is done
            if (sheetUrlInput.value.trim().length > 0 && !sendSheetBtn.disabled && resultOutput.value.length > 0) {
                sendSheetBtn.style.display = 'inline-block';
            } else {
                sendSheetBtn.style.display = 'none';
            }
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles({ target: { files: files } });
        }

        function handleFiles(e) {
            const file = e.target.files[0];
            if (!file) return;

            const validTypes = ['image/jpeg', 'image/png', 'image/webp', 'application/pdf'];
            if (!validTypes.includes(file.type)) {
                alert('不支援的檔案格式。請上傳 JPG, PNG, WEBP 或 PDF。');
                return;
            }

            currentFile = file;
            
            const reader = new FileReader();
            reader.onloadend = function() {
                currentBase64 = reader.result.split(',')[1];
            }
            reader.readAsDataURL(file);

            previewContainer.style.display = 'block';
            dropZone.style.display = 'none';
            analyzeBtn.disabled = false;

            if (file.type.startsWith('image/')) {
                imagePreviewBox.style.display = 'block';
                filePreviewBox.style.display = 'none';
                imgPreview.src = URL.createObjectURL(file);
            } else {
                imagePreviewBox.style.display = 'none';
                filePreviewBox.style.display = 'block';
                fileNameDisplay.textContent = file.name;
            }
        }

        function resetFile() {
            currentFile = null;
            currentBase64 = null;
            fileInput.value = '';
            previewContainer.style.display = 'none';
            dropZone.style.display = 'block';
            analyzeBtn.disabled = true;
            resultOutput.value = '';
            disableExportButtons();
            toggleSheetButton();
        }

        function disableExportButtons() {
            downloadTxtBtn.disabled = true;
            downloadPdfBtn.disabled = true;
            downloadCsvBtn.disabled = true;
            copyBtn.disabled = true;
            sendSheetBtn.disabled = true;
        }

        function enableExportButtons() {
            downloadTxtBtn.disabled = false;
            downloadPdfBtn.disabled = false;
            downloadCsvBtn.disabled = false;
            copyBtn.disabled = false;
            sendSheetBtn.disabled = false;
            toggleSheetButton();
        }

        async function startAnalysis() {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                alert('請輸入 Google AI Studio API Key');
                return;
            }
            if (!currentBase64) {
                alert('請先上傳檔案');
                return;
            }

            // Determine Prompt based on selection
            const analysisType = analysisTypeSelect.value;
            let promptText = "";

            // Unified System Instruction for Structured Output (Used for Opt 2 & 3)
            // UPDATED: Added STRICT instruction for FULL CHINESE TRANSLATION
            const structuredSystemPrompt = `
                請擔任 AI 圖像生成專家與資料分析師。
                請依據指示產生結構化的 YAML 資料。
                請勿使用 Markdown 標記（如 \`\`\`yaml），直接輸出 YAML 內容。
                
                必要欄位 (Keys) 順序如下，請嚴格遵守：
                subject: (主體描述 - 繁體中文)
                action: (動作/動態 - 繁體中文)
                scene: (場景/環境 - 繁體中文)
                visual_style: (視覺風格 - 繁體中文)
                lighting: (光線/氛圍 - 繁體中文)
                composition: (構圖/視角 - 繁體中文)
                
                negative_prompt: (
                    1. 先列出英文 Negative Prompt (例如：low quality, bad anatomy...)
                    2. 接著在括號 ( ) 內提供繁體中文說明。
                )

                colors: (請分析並列出畫面中的 Hex Code，包含主色、輔助色與特殊色，格式如：#FF0000 (Main), #00FF00 (Sub)...)
                
                full_prompt: (
                    此欄位放在最後，請依照以下結構生成，並確保包含中英文：
                    1. [English Prompt]: 產生一段高品質、可直接用於 Stable Diffusion 的英文提示詞。
                       - 必須包含上述的主體、動作、場景、光線。
                       - **強制要求**：將 colors 欄位中的色系 Hex Code 與描述，直接寫入此段英文 Prompt 中。
                       - **強制要求**：將 negative_prompt 欄位的內容作為參數加入 (例如: --no low quality...)。
                    2. [Chinese Translation]: 換行後，請提供該英文 Prompt 的「完整繁體中文翻譯」，確保每一個描述詞（包含風格、光影、材質、色系）都有對應的中文翻譯，請勿僅做摘要。
                )
            `;

            if (analysisType === 'reverse_prompt') {
                // Option 1: Deep Analysis Prompt (Text Output) - UPDATED FOR OPTION 1
                promptText = `
                    請擔任 AI 圖像生成專家。
                    1. 請先用英文撰寫一段完整、高品質的 Prompt，包含視覺風格、藝術流派、光影、構圖、材質質感、色系等細節。
                    2. **重要：** 在英文 Prompt 之後，請務必換行，並提供這段 Prompt 的「完整繁體中文翻譯」。
                    3. 請確保翻譯是「逐字對應」的，不要省略任何技術詞彙或風格描述。
                    4. 最後，請提供一份繁體中文的深度風格分析報告。
                `;
            
            } else if (analysisType === 'analyze_image') {
                // Option 2
                promptText = `
                    ${structuredSystemPrompt}
                    
                    任務：
                    請分析上傳的檔案（圖像），重點在於「藝術風格」、「攝影光影」與「繪圖細節」。
                    請依據圖片的真實內容填入上述 YAML 欄位。
                    **特別注意：full_prompt 必須強制包含具體的色系代碼 (Hex) 與負面提示詞，並且翻譯必須完整。**
                `;

            } else if (analysisType === 'analyze_slide') {
                // Option 3
                promptText = `
                    ${structuredSystemPrompt}
                    
                    任務：
                    請分析上傳的檔案（簡報投影片），重點在於「版面配置」、「資訊層級」與「簡報設計風格」。
                    
                    欄位填寫指南：
                    subject: 簡報的主題或核心訊息。
                    action: 畫面的動線引導或動態元素。
                    scene: 簡報的背景設計與排版結構。
                    visual_style: 簡報的整體設計語言（如：扁平化、科技感、極簡風）。
                    lighting: 畫面整體的明暗對比與氛圍。
                    composition: 圖文排版與視角。
                `;

            } else if (analysisType === 'custom') {
                // Option 4
                const customPrompt = customPromptInput.value.trim();
                if (!customPrompt) {
                    alert('請輸入「自定義提示詞」');
                    customPromptInput.focus();
                    return;
                }
                promptText = customPrompt;
            }

            loadingOverlay.style.display = 'flex';
            analyzeBtn.disabled = true;
            resultOutput.value = '正在聯繫 Gemini 進行分析...';

            try {
                // Using gemini-2.5-flash-preview-09-2025
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: promptText },
                                { inlineData: { mimeType: currentFile.type, data: currentBase64 } }
                            ]
                        }]
                    })
                });

                const data = await response.json();

                if (data.error) throw new Error(data.error.message);
                if (!data.candidates || !data.candidates[0].content) throw new Error("無回應內容");

                let text = data.candidates[0].content.parts[0].text;
                // Cleanup common markdown formatting
                text = text.replace(/^```[a-z]*\n/i, '').replace(/\n```$/, '').trim();

                resultOutput.value = text;
                enableExportButtons();

            } catch (error) {
                console.error(error);
                resultOutput.value = `發生錯誤: ${error.message}`;
                alert(`分析失敗: ${error.message}`);
            } finally {
                loadingOverlay.style.display = 'none';
                analyzeBtn.disabled = false;
            }
        }

        // --- Helper: Parse Data (Parsing Logic Updated) ---
        function getParsedData() {
            const content = resultOutput.value;
            if (!content) return null;
            
            // Helper to clean quotes and whitespace
            const clean = (str) => str ? str.replace(/^["']|["']$/g, '').trim() : "";

            // Old single-line regex (kept for simple fields)
            const getVal = (key) => {
                const regex = new RegExp(`${key}:\\s*(.*?)$`, "m");
                const match = content.match(regex);
                return match ? clean(match[1]) : "";
            };

            // NEW Multiline regex: Captures everything until the next key (start of line followed by word and colon)
            const getMultiLineVal = (key) => {
                const regex = new RegExp(`${key}:([\\s\\S]*?)(?=\\n[a-z_]+:|$)`, "i");
                const match = content.match(regex);
                return match ? clean(match[1]) : "";
            };

            // Check if we are in YAML mode
            const subject = getVal("subject");
            const visualStyle = getVal("visual_style");

            // For full_prompt and negative_prompt, use multiline parsing
            const fullPrompt = getMultiLineVal("full_prompt");
            const negativePrompt = getMultiLineVal("negative_prompt");
            const colors = getVal("colors"); // Colors usually short enough for single line, but let's be safe
            
            return {
                filename: currentFile ? currentFile.name : "unknown_file",
                subject: subject || "文字模式/未偵測",
                action: getVal("action"),
                scene: getVal("scene"),
                visual_style: visualStyle || getVal("style_name"), 
                lighting: getVal("lighting"),
                composition: getVal("composition"),
                // Use multiline results
                negative_prompt: negativePrompt || getVal("negative_prompt"),
                full_prompt: fullPrompt || getVal("full_prompt"),
                colors: colors
            };
        }

        // --- Sheet Integration ---
        async function sendToSheet() {
            const url = sheetUrlInput.value.trim();
            if (!url) {
                alert("請先在設定區輸入 Google Apps Script URL");
                return;
            }

            const data = getParsedData();
            if (!data) return;
            
            // Warning if data looks empty (likely wrong mode selected)
            if (data.subject === "文字模式/未偵測" && !data.visual_style) {
                const confirmSend = confirm("偵測到分析結果可能不是 Sheet 專用的 YAML 格式（可能是文字模式）。\n\n傳送至 Sheet 可能會導致欄位空白或錯誤。\n\n確定要繼續嗎？");
                if (!confirmSend) return;
            }

            const originalBtnText = sendSheetBtn.innerHTML;
            sendSheetBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 傳送中...';
            sendSheetBtn.disabled = true;

            try {
                await fetch(url, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(data)
                });

                alert("請求已發送！\n資料應已寫入您的 Google Sheet。");
                
            } catch (error) {
                console.error(error);
                alert("傳送失敗，請檢查 URL。");
            } finally {
                sendSheetBtn.innerHTML = originalBtnText;
                sendSheetBtn.disabled = false;
            }
        }

        // --- Existing Export Functions ---
        function copyToClipboard() {
            const content = resultOutput.value;
            if (!content) return;
            resultOutput.select();
            resultOutput.setSelectionRange(0, 99999);
            try {
                const successful = document.execCommand('copy');
                if(successful) {
                    const originalHtml = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<i class="fas fa-check me-1"></i> 已複製';
                    copyBtn.classList.replace('btn-outline-primary', 'btn-success');
                    setTimeout(() => {
                        copyBtn.innerHTML = originalHtml;
                        copyBtn.classList.replace('btn-success', 'btn-outline-primary');
                    }, 2000);
                } else alert('複製失敗');
            } catch (err) { alert('不支援自動複製'); }
            window.getSelection().removeAllRanges();
        }

        function exportToTxt() {
            const content = resultOutput.value;
            if (!content) return;
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `style_analysis_${new Date().getTime()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportToCsv() {
            const data = getParsedData();
            if (!data) return;

            const date = new Date().toLocaleString('zh-TW');
            
            // CSV Headers
            const headers = "檔案名稱,主體,動作,場景,視覺風格,光線,構圖,負面提示詞,色系,完整 Prompt\n";
            
            // CSV Row (Updated Order)
            const row = `"${data.filename}","${data.subject}","${data.action}","${data.scene}","${data.visual_style}","${data.lighting}","${data.composition}","${data.negative_prompt.replace(/"/g, '""')}","${data.colors}","${data.full_prompt.replace(/"/g, '""')}"`;

            const csvContent = "\uFEFF" + headers + row;

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `style_analysis_${new Date().getTime()}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function exportToPdf() {
            const content = resultOutput.value;
            if (!content) return;
            const renderTarget = document.getElementById('pdf-render-source');
            document.getElementById('pdfContent').textContent = content;
            document.getElementById('pdfDate').textContent = new Date().toLocaleString('zh-TW');
            renderTarget.style.display = 'block';

            try {
                const originalText = downloadPdfBtn.innerHTML;
                downloadPdfBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 處理中...';
                downloadPdfBtn.disabled = true;

                const canvas = await html2canvas(renderTarget, { scale: 2, useCORS: true });
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                pdf.save(`style_analysis_${new Date().getTime()}.pdf`);
            } catch (error) {
                console.error(error);
                alert('PDF 產生失敗');
            } finally {
                renderTarget.style.display = 'none';
                downloadPdfBtn.innerHTML = '<i class="fas fa-file-pdf me-1"></i> 下載 .pdf';
                downloadPdfBtn.disabled = false;
            }
        }
    </script>
</body>
</html>